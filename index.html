<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bike Hacker Tracker — Live Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#00d1ff; --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071025 0%, #071426 70%);color:#e6eef8}
  .wrap{max-width:1200px;margin:18px auto;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-radius:12px;background:linear-gradient(90deg,#071a2b,#092235);box-shadow:0 6px 30px rgba(2,6,23,0.6)}
  header h1{margin:0;font-size:1.05rem;letter-spacing:0.2px}
  header .meta{font-size:0.85rem;color:var(--muted)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  label{display:block;color:var(--muted);font-size:0.82rem;margin-bottom:8px}
  input[type=text], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8}
  .btn{display:inline-block;padding:9px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#037fff);color:#002; font-weight:700;border:0;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px}
  .row{display:flex;gap:8px}
  .small{font-size:0.85rem;color:var(--muted)}
  #embedArea{height:360px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  iframe{width:100%;height:100%;border:0}
  #map{height:720px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .info{padding:10px;margin-top:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));font-size:0.9rem}
  .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
  .stat{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);text-align:center}
  .stat h3{margin:0;font-size:1.02rem}
  .stat p{margin:0;color:var(--muted);font-size:0.82rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:0.85rem;margin-top:12px}
  a.link{color:var(--accent);text-decoration:none}
  /* playback tiny */
  .playback {display:flex;gap:8px;align-items:center}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:0.85rem;color:var(--muted)}
  /* responsive */
  @media (max-width:980px){ .wrap{grid-template-columns:1fr; padding:12px} header{flex-direction:column;gap:8px} #map{height:420px} #embedArea{height:240px} }
</style>
</head>
<body>
<header>
  <div><h1>Bike Hacker Tracker</h1><div class="small">Pro dashboard • single file</div></div>
  <div class="meta">Made for you — keep sharing link private</div>
</header>

<div class="wrap">
  <!-- LEFT CONTROLS -->
  <div class="card">
    <label>Permanent sharing link</label>
    <input id="shareUrl" placeholder="http://.../sharing/xxxx" />
    <div class="row" style="margin-top:10px">
      <button id="loadBtn" class="btn">Load</button>
      <button id="openBtn" class="btn-ghost">Open</button>
    </div>

    <div style="margin-top:12px">
      <label>Status & Auto refresh</label>
      <div class="row">
        <div id="statusBadge" class="chip">Not checked</div>
        <div style="flex:1"><small id="lastPing" class="small">—</small></div>
      </div>
      <div style="margin-top:8px" class="row">
        <button id="pingBtn" class="btn-ghost">Ping</button>
        <select id="interval" title="Refresh interval"><option value="10">10s</option><option value="20" selected>20s</option><option value="30">30s</option><option value="60">60s</option></select>
        <button id="toggleAuto" class="btn">Auto: OFF</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Quick tools</label>
      <div class="controls">
        <button id="copyBtn" class="btn-ghost">Copy Link</button>
        <button id="qrBtn" class="btn-ghost">QR</button>
        <button id="copyUrlCmd" class="btn-ghost">Copy URL#</button>
        <button id="copyGCmd" class="btn-ghost">Copy G#</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Latest position</label>
      <div class="info" id="infoBox">No position yet.</div>
      <div class="stat-grid">
        <div class="stat"><h3 id="spd">—</h3><p>Speed (km/h)</p></div>
        <div class="stat"><h3 id="alt">—</h3><p>Accuracy / info</p></div>
        <div class="stat"><h3 id="lastSeen">—</h3><p>Last seen</p></div>
        <div class="stat"><h3 id="bearing">—</h3><p>Bearing</p></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Route & playback</label>
      <div class="controls">
        <button id="exportCsv" class="btn-ghost">Export CSV</button>
        <button id="showHeat" class="btn-ghost">Heatmap</button>
        <button id="playPause" class="btn">Play</button>
        <button id="clearRoute" class="btn-ghost">Clear</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Geofence (simulator)</label>
      <input id="geoLat" placeholder="lat e.g. 23.7964" />
      <input id="geoLng" placeholder="lng e.g. 90.4361" style="margin-top:6px" />
      <div class="row" style="margin-top:8px">
        <input id="geoRad" placeholder="radius (m)" />
        <button id="setFence" class="btn-ghost">Set</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="testCoords" class="btn-ghost">Test Coords</button>
      </div>
    </div>

  </div>

  <!-- RIGHT: Map + embed -->
  <div>
    <div class="card" id="embedArea">
      <!-- iframe will be set here -->
      <iframe id="trackerFrame" src="about:blank" sandbox></iframe>
    </div>

    <div id="map" style="margin-top:12px" class="card"></div>
  </div>
</div>

<footer>Tip: Add to Home Screen for quick access • Use responsibly</footer>

<!-- libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
/* ===============================
  CONFIG — এখানে তোমার DEFAULT sharing link বসবে
   — যদি এই লাইনেই তোমার link বসাতে চাও, বদলে ফেলো
================================ */
const DEFAULT_SHARING = 'http://gps.francebangla.net/sharing/3cc72e30b02e2948c35e7c96ba602695';

/* ===============================
   App state
================================ */
const $ = s => document.querySelector(s);
const shareInput = $('#shareUrl');
const frame = $('#trackerFrame');
const statusBadge = $('#statusBadge');
const lastPing = $('#lastPing');
const infoBox = $('#infoBox');
const spdBox = $('#spd'), altBox = $('#alt'), seenBox = $('#lastSeen'), bearingBox = $('#bearing');

shareInput.value = localStorage.getItem('shareLink') || DEFAULT_SHARING;

/* Map setup */
const map = L.map('map', {zoomControl:true}).setView([23.7964,90.4361], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:''}).addTo(map);
let route = []; let marker=null, heatLayer=null, routeLayer=null, fence=null;
function setMarker(lat,lng, bearing){
  if(!marker){
    marker = L.marker([lat,lng], {rotationAngle: bearing||0}).addTo(map);
  } else{
    marker.setLatLng([lat,lng]);
    if(bearing!==undefined && marker.setRotationAngle) try{ marker.setRotationAngle(bearing); }catch(e){}
  }
  map.setView([lat,lng], 16);
}

/* parse coords from raw HTML/text using patterns */
function parseCoordsFromText(txt){
  // try google q=lat,lng
  let m = txt.match(/[?&]q=([N\d\.\-]+),([E\d\.\-]+)/i) || txt.match(/q=([\d\.\-]+),([\d\.\-]+)/i);
  if(m){ return {lat: parseFloat(m[1].replace('N','')), lng: parseFloat(m[2].replace('E',''))}; }
  // try plain lat,lng
  m = txt.match(/([0-9]{1,2}\.[0-9]+)[,\\s]+([0-9]{1,3}\.[0-9]+)/);
  if(m){ return {lat: parseFloat(m[1]), lng: parseFloat(m[2])}; }
  return null;
}

/* ping (CORS-aware) */
async function ping(url){
  if(!url) return setBadge('No URL','gray');
  setBadge('Checking...','orange');
  lastPing.textContent = '';
  try{
    const resp = await fetch(url, {mode:'cors'});
    if(resp.ok){
      setBadge('Online (CORS)','green'); lastPing.textContent = new Date().toLocaleString();
      const txt = await resp.text();
      const coords = parseCoordsFromText(txt);
      if(coords){ onNewPosition(coords.lat, coords.lng); infoBox.textContent = 'Parsed coords (CORS).'; }
      return true;
    } else {
      setBadge('HTTP '+resp.status,'red');
      return false;
    }
  }catch(e){
    // attempt image probe (non-cors)
    const alive = await probe(url);
    if(alive){ setBadge('Online (no CORS)','green'); lastPing.textContent = new Date().toLocaleString(); infoBox.textContent='Open-in-new-tab recommended'; }
    else { setBadge('Offline','red'); infoBox.textContent='Server unreachable'; }
    return alive;
  }
}

function setBadge(text, color){
  statusBadge.textContent = text;
  statusBadge.style.background = (color==='green')? 'rgba(0,209,255,0.08)' : (color==='orange'? 'rgba(255,211,0,0.06)' : (color==='red'? 'rgba(255,100,100,0.06)' : 'rgba(255,255,255,0.02)'));
  statusBadge.style.color = (color==='green')? '#00d1ff' : (color==='red'? '#ff6b6b' : '#ffd166');
}

// image probe
function probe(url){ return new Promise(resolve=>{
  try{
    const img = new Image();
    img.onload = ()=> resolve(true);
    img.onerror = ()=> resolve(false);
    img.src = url + (url.includes('?')? '&':'?') + '_ping=' + Date.now();
    setTimeout(()=> resolve(false), 6000);
  }catch(e){ resolve(false); }
}); }

/* embed + fallback */
function loadEmbed(u){
  if(!u){ alert('Paste sharing link first'); return; }
  localStorage.setItem('shareLink', u);
  // reset iframe
  document.getElementById('embedArea').innerHTML = '<iframe id="trackerFrame" src="about:blank" sandbox></iframe>';
  const ifr = document.getElementById('trackerFrame');
  let loaded=false;
  ifr.addEventListener('load', ()=>{ loaded=true; setBadge('Embedded','green'); lastPing.textContent = new Date().toLocaleString(); });
  try{ ifr.src = u; }catch(e){ console.warn(e); }
  setTimeout(()=>{ if(!loaded){
    document.getElementById('embedArea').innerHTML = '<div style="padding:18px;text-align:center"><p class="small">Embedding blocked. Open in new tab:</p><a class="btn" href="'+escapeHtml(u)+'" target="_blank">Open Live Tracker</a></div>';
    setBadge('Embed blocked','red');
  } }, 1400);
}

/* extract coords when we get lat/lng and optionally time */
function onNewPosition(lat,lng, t){
  // add to route
  const ts = t || new Date().toISOString();
  route.push({lat, lng, t:ts});
  setMarker(lat,lng);
  seenBox.textContent = new Date(ts).toLocaleString();
  infoBox.innerHTML = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} <br>Points: ${route.length}`;
  // calc speed if possible
  if(route.length>=2){
    const a = route[route.length-2], b = route[route.length-1];
    const s = estimateSpeed(a.lat,a.lng,b.lat,b.lng, a.t, b.t); // km/h
    spdBox.textContent = (s===null)? '—' : s.toFixed(1);
    bearingBox.textContent = bearing(a.lat,a.lng,b.lat,b.lng).toFixed(0)+'°';
  }
  // update route layer
  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.polyline(route.map(p=>[p.lat,p.lng]), {color:'#00d1ff', weight:4, opacity:0.8}).addTo(map);
}

/* distance & speed helpers */
function toRad(v){ return v * Math.PI/180; }
function haversine(lat1,lon1,lat2,lon2){
  const R=6371; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c; // km
}
function estimateSpeed(lat1,lon1,lat2,lon2,t1,t2){
  let dt = (new Date(t2).getTime() - new Date(t1).getTime())/1000; // sec
  if(!isFinite(dt) || dt<=0) return null;
  const dist = haversine(lat1,lon1,lat2,lon2); // km
  const v = (dist / (dt/3600)); // km/h
  if(!isFinite(v)) return null; return v;
}
function bearing(lat1,lon1,lat2,lon2){
  const y = Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
  const x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
  return ( (Math.atan2(y,x)*180/Math.PI)+360 )%360;
}

/* CSV export */
function exportCSV(){
  if(route.length===0){ alert('Route empty'); return; }
  let csv = 'lat,lng,timestamp\n';
  route.forEach(r=> csv += `${r.lat},${r.lng},${r.t}\n`);
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'route.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* heatmap */
function showHeat(){
  if(route.length===0) return alert('No route, collect first (ping/load link).');
  const pts = route.map(p=>[p.lat,p.lng]);
  if(heatLayer) map.removeLayer(heatLayer);
  heatLayer = L.heatLayer(pts, {radius:25}).addTo(map);
  map.fitBounds(L.latLngBounds(pts));
}

/* playback */
let playInterval=null;
function playPauseToggle(){
  if(playInterval){ clearInterval(playInterval); playInterval=null; $('#playPause').textContent='Play'; return; }
  if(route.length===0) return alert('No route to play.');
  let i=0;
  $('#playPause').textContent='Pause';
  playInterval = setInterval(()=>{ if(i>=route.length){ clearInterval(playInterval); playInterval=null; $('#playPause').textContent='Play'; return; } const p=route[i++]; setMarker(p.lat,p.lng); }, 700);
}

/* clear */
function clearAll(){ if(routeLayer) map.removeLayer(routeLayer); if(heatLayer) map.removeLayer(heatLayer); if(marker) map.removeLayer(marker); route=[]; routeLayer=heatLayer=marker=null; infoBox.textContent='Cleared'; spdBox.textContent='—'; seenBox.textContent='—'; }

/* geofence */
function setFence(){
  const lat=parseFloat($('#geoLat').value), lng=parseFloat($('#geoLng').value), r=parseFloat($('#geoRad').value);
  if(isNaN(lat)||isNaN(lng)||isNaN(r)) return alert('Provide valid numbers');
  if(fence) map.removeLayer(fence);
  fence = L.circle([lat,lng], {radius:r, color:'#ff6b6b', fillOpacity:0.12}).addTo(map);
  map.fitBounds(fence.getBounds());
}
function testCoords(){
  const lat=parseFloat($('#geoLat').value), lng=parseFloat($('#geoLng').value);
  if(isNaN(lat)||isNaN(lng)) return alert('Provide coords');
  const inside = fence && fence.getBounds().contains([lat,lng]);
  alert(inside? 'INSIDE fence' : 'OUTSIDE fence');
}

/* helpers */
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

/* QR generator */
function openQR(u){ const qr='https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl='+encodeURIComponent(u); window.open(qr,'_blank'); }

/* auto-refresh */
let autoTimer=null;
function toggleAuto(on){
  const btn = $('#toggleAuto');
  if(on){
    const sec = parseInt($('#interval').value,10) * 1000;
    autoTimer = setInterval(()=> { ping( shareInput.value.trim() ); }, sec);
    btn.textContent = 'Auto: ON';
    btn.classList.add('btn');
  } else {
    clearInterval(autoTimer); autoTimer=null;
    btn.textContent = 'Auto: OFF';
  }
}

/* image probe used earlier */
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

/* event wiring */
$('#loadBtn').addEventListener('click', ()=> loadEmbed(shareInput.value.trim()));
$('#openBtn').addEventListener('click', ()=> { const u=shareInput.value.trim(); if(!u) return alert('Paste link'); window.open(u,'_blank'); });
$('#pingBtn').addEventListener('click', ()=> ping(shareInput.value.trim()));
$('#copyBtn').addEventListener('click', ()=> { navigator.clipboard.writeText(shareInput.value.trim()); alert('Copied'); });
$('#qrBtn').addEventListener('click', ()=> openQR(shareInput.value.trim()));
$('#copyUrlCmd').addEventListener('click', ()=> { navigator.clipboard.writeText('URL#'); alert('Copied URL#'); });
$('#copyGCmd').addEventListener('click', ()=> { navigator.clipboard.writeText('G#'); alert('Copied G#'); });

$('#exportCsv').addEventListener('click', exportCSV);
$('#showHeat').addEventListener('click', showHeat);
$('#playPause').addEventListener('click', playPauseToggle);
$('#clearRoute').addEventListener('click', clearAll);
$('#setFence').addEventListener('click', setFence);
$('#testCoords').addEventListener('click', testCoords);

$('#toggleAuto').addEventListener('click', ()=> { toggleAuto(!autoTimer); });

// load defaults on start
setTimeout(()=>{ loadEmbed(shareInput.value.trim()); ping(shareInput.value.trim()); }, 700);

/* accessibility: save link on change */
shareInput.addEventListener('change', ()=> localStorage.setItem('shareLink', shareInput.value.trim()));

</script>
</body>
</html>
